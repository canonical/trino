# Apache Ranger access control
* Apache Ranger access control plugin supports use of Apache Ranger policies to authorize data access in Trino - like operations on catalogs, schemas, tables, columns.
* Column-masking and row-filtering are supported by the plugin.
* Accesses authorized by the plugin are audited for compliance purposes.

## Requirements
* Access to a Apache Ranger deployment having authorization policies to be enforced
* Access to audit stores (Solr/HDFS/Log4J/S3) to save access audit logs
* Apache Ranger 2.5.0 includes Trino service-def required by this access control plugin. In earlier versions of Apache Ranger, Trino service-def will have to be updated to the version [here](
  https://github.com/apache/ranger/blob/ranger-2.5/agents-common/src/main/resources/service-defs/ranger-servicedef-trino.json).

## Configuration
Setup following configuration files to configure Apache Ranger as the authorizer in Trino:

### /etc/trino/access-control.properties
```properties
access-control.name=ranger

# name of the service having policies to be enforced by the plugin
# Default: dev_trino
ranger.service_name=dev_trino

# used in Hadoop environments
# Path to hadoop configuration
# Default: trino-ranger-site.xml in classpath
ranger.hadoop_config=trino-ranger-site.xml

# used in Hadoop environments using Kerberos authentication
#   true:  use Hadoop's UserGroupInformation class to obtain groups; typically used in environments using Kerberos
#   false: use Trino's Identity class to obtain groups
# Default: false
ranger.use_ugi=false

# used in Hadoop environments using Kerberos authentication
# path to keytab file
# Default: empty
ranger.keytab=

# used in Hadoop environments using Kerberos authentication
# the name of the Kerberos principal
# Default: empty
ranger.principal=

# configurations to connect to Apache Ranger deployment
# Default: ranger-trino-security.xml in classpath
ranger.security_config=/etc/trino/ranger-trino-security.xml

# configurations to connect to audit stores
# Default: ranger-trino-audit.xml in classpath
ranger.audit_config=/etc/trino/ranger-trino-audit.xml

# configurations to connect to SSL endpoint
# Default: ranger-policymgr-ssl.xml in classpath
ranger.policy_mgr_ssl_config=/etc/trino/ranger-policymgr-ssl.xml
```

### ranger-trino-security.xml
```properties

# mandatory configuration
# a comma separated list of URLs to Apache Ranger instances in a deployment
ranger.plugin.trino.policy.rest.url=

# name to identify the cluster running the Trino instance
# this is recorded in audit logs generated by the plugin
# Default: empty
ranger.plugin.trino.access.cluster.name=

# boolean flag to specify whether to use user-groups mapping available in Apache Ranger
# Default: false
ranger.plugin.trino.use.rangerGroups=false

# when above configuration is true, this boolean flag specifies:
#   true:  Apache Ranger is the only source of user-to-groups mapping
#   false: user-group mapping in Apache Ranger and Trino will be combined
# Default: false
ranger.plugin.trino.use.only.rangerGroups=false

# superusers will be authorized for all accesses, without requiring explicit policy grants
# Default: empty
ranger.plugin.trino.super.users=

# users in supergroups will be authorized for all accesses, without requiring explicit policy grants
# Default: empty
ranger.plugin.trino.super.groups=
```

### ranger-trino-audit.xml
```properties
# Default: true
xasecure.audit.is.enabled=true


# boolean flag to specify if audit logs should be stored in Solr
# Default: false
xasecure.audit.solr.is.enabled=false

# URL to Solr deployment where the plugin should send access audits to
# Default: empty
xasecure.audit.solr.solr_url=

# boolean flag to specify if audit logs should be stored in HDFS
# Default: false
xasecure.audit.hdfs.is.enabled=false

# Default: empty
xasecure.audit.hdfs.config.destination.directory=

# Default: empty
xasecure.audit.hdfs.config.destination.file=

# Default: 900 (15 minutes)
xasecure.audit.hdfs.config.destination.flush.interval.seconds

# Default: 86400 (1 day)
xasecure.audit.hdfs.config.destination.rollover.interval.seconds


# boolean flag to specify if audit logs should be sent to log4j appender
# when enabled, audit logs will be sent to log4j logger named xaaudit.org.apache.ranger.audit.provider.Log4jAuditProvider
# Default: false
xasecure.audit.log4j.is.enabled=false
```

### ranger-policymgr-ssl.xml
```properties
# properties used for 2-way SSL between the Trino plugin and Apache Ranger server

# path to keystore file
# Default: empty
xasecure.policymgr.clientssl.keystore=

# type of keystore
# Default: jks
xasecure.policymgr.clientssl.keystore.type=jks

# path to credential file for the keystore; the credential should be in alias sslKeyStore
# Default: empty
xasecure.policymgr.clientssl.keystore.credential.file=

# path to truststore file
# Default: empty
xasecure.policymgr.clientssl.truststore=

# type of truststore
# Default: jks
xasecure.policymgr.clientssl.truststore.type=jks

# path to credential file for the truststore; the credential should be in alias sslTrustStore
# Default: empty
xasecure.policymgr.clientssl.truststore.credential.file=
```

## Required policies
* Users will need permission to execute queries in Trino. To allow this, please create a policy for `queryId=*` with `permission=execute` for `user={USER}`.
* Users will need permission to impersonate themselves in Trino. To allow this, please create a policy for `trinouser={USER}` with `permission=impersonate` for `user={USER}`. 
